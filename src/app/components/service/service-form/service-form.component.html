<app-form-toolbar
  icon="menu_servei"
  entityType="serviceEntity.service"
  [itemName]="itemName('name')"
  [isNew]="isNewOrDuplicated()"
  (save)="onSaveButtonClicked()"
  (back)="utils.navigateBack()">
</app-form-toolbar>

<mat-tab-group
  mat-stretch-tabs="false"
  mat-align-tabs="end"
  [dynamicHeight]="true"
  preserveContent="true">
  <mat-tab label="{{ 'serviceEntity.generalData' | translate }}">
    <form [formGroup]='entityForm' *ngIf="dataLoaded">
      <mat-card class="sitmun-mat-card-margin" appearance="outlined">
        <mat-card-content>
          <mat-form-field appearance="outline" class="full">
            <mat-label>{{ 'serviceEntity.name' | translate }}</mat-label>
            <input matInput type="text" formControlName="name"  [maxlength]="60" required>
            <mat-hint align="end" [class.text-warning]="entityForm.get('name')?.value?.length > 60">
              {{entityForm.get('name') | characterCount}}
              <mat-icon *ngIf="entityForm.get('name')?.value?.length > 60" fontIcon="warning" class="warning-icon"></mat-icon>
            </mat-hint>
            <mat-icon matSuffix class="iconTranslate"
                      (click)="onTranslated('name')"
                      onKeyDown="onTranslated('name')"
                      svgIcon="ic_translate"></mat-icon>
          </mat-form-field>
          <mat-form-field appearance="outline" class="full">
            <mat-label>{{ 'serviceEntity.description' | translate }}</mat-label>
            <textarea matInput type="text" formControlName="description" [maxlength]="4000"> </textarea>
            <mat-hint align="end">{{entityForm.get('description') | characterCount}}</mat-hint>
            <mat-icon matSuffix class="iconTranslate"
                      (click)="onTranslated('description')"
                      onKeyDown="onTranslated('description')"
                      svgIcon="ic_translate"></mat-icon>
          </mat-form-field>
          <mat-checkbox formControlName="blocked">
            {{ 'serviceEntity.available' | translate }}
          </mat-checkbox>
        </mat-card-content>
      </mat-card>

      <mat-card class="sitmun-mat-card-margin" appearance="outlined">
        <mat-card-content>
          <mat-form-field appearance="outline" class="quarter add-gap">
            <mat-label>{{ 'serviceEntity.type' | translate }}</mat-label>
            <mat-select formControlName="type" class="form-control" (selectionChange)="onTypeChange($event)" required>
              <mat-option [value]="serviceType.value" *ngFor="let serviceType of this.codeList('service.type')">
                {{ serviceType.description }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <button
            mat-raised-button
            class="sitmun-action-button"
            type="button"
            *ngIf="isWMS()"
            (click)="onUpdateServiceMetadata()"
          >
            {{ (isNewOrDuplicated() ? 'serviceEntity.getData' : 'serviceEntity.updateData') | translate }}
          </button>

          <mat-form-field appearance="outline" class="full">
            <mat-label>{{ 'serviceEntity.url' | translate }}</mat-label>
            <input matInput type="text" formControlName="serviceURL" required [maxlength]="4000">
            <mat-hint align="end">{{entityForm.get('serviceURL') | characterCount}}</mat-hint>
          </mat-form-field>
          <mat-form-field appearance="outline" class="full">
            <mat-label>{{ 'serviceEntity.metadataURL' | translate }}</mat-label>
            <input matInput type="text" formControlName="getInformationURL"  [maxlength]="4000">
            <mat-hint align="end">{{entityForm.get('getInformationURL') | characterCount}}</mat-hint>
          </mat-form-field>
          <mat-form-field appearance="outline" class="full">
            <mat-label>{{ 'serviceEntity.projections' | translate }}</mat-label>
            <mat-chip-grid #chipList aria-label="Selecció de projecció" formControlName="supportedSRS">
              <mat-chip-row
                *ngFor="let srs of this.entityForm.get('supportedSRS')?.value"
                [removable]="canRemoveProjections"
                (removed)="removeProjection(srs)">
                {{ srs }}
                <button matChipRemove>
                  <mat-icon>cancel</mat-icon>
                </button>
              </mat-chip-row>
              <input
                [matChipInputFor]="chipList"
                [matChipInputSeparatorKeyCodes]="separatorKeysCodesForProjections"
                [matChipInputAddOnBlur]="addProjectionsOnBlur"
                (matChipInputTokenEnd)="addProjection($event)"
              />
            </mat-chip-grid>
            <mat-hint align="end">{{entityForm.get('supportedSRS') | characterCount:250}}</mat-hint>
          </mat-form-field>
          <mat-checkbox formControlName="isProxied">
            {{ 'serviceEntity.proxied' | translate }}
          </mat-checkbox>
        </mat-card-content>
      </mat-card>

      <mat-card class="sitmun-mat-card-margin" appearance="outlined">
        <mat-card-content>
          <mat-form-field appearance="outline" class="quarter">
            <mat-label>{{ 'serviceEntity.authenticationMode' | translate }}</mat-label>
            <mat-select formControlName="authenticationMode" class="form-control" required>
              <mat-option [value]="mode.value" *ngFor="let mode of this.codeList('service.authenticationMode')">
                {{ mode.description }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <div class="break"></div>
          <mat-form-field appearance="outline"
                          *ngIf="isAuthenticationModeNode()"
                          class="half add-gap"
          >
            <mat-label>{{ 'serviceEntity.user' | translate }}</mat-label>
            <input matInput type="text" formControlName="user" [maxlength]="50">
            <mat-hint align="end">{{entityForm.get('user') | characterCount}}</mat-hint>
          </mat-form-field>
          <mat-form-field appearance="outline"
                          *ngIf="isAuthenticationModeNode()"
                          class="half"
          >
            <mat-label>{{ 'serviceEntity.password' | translate }}</mat-label>
            <input matInput [type]="'text'" formControlName="password" [maxlength]="50">
            <mat-hint align="end">{{entityForm.get('password') | characterCount}}</mat-hint>
          </mat-form-field>
        </mat-card-content>
      </mat-card>
    </form>
  </mat-tab>
  <mat-tab label="{{ 'serviceEntity.layersToRegister' | translate }}">
    <mat-card appearance="outlined">
      <mat-card-content>
        <button
          mat-raised-button
          class="sitmun-mat-button-margin sitmun-action-button"
          id="capabilitiesButton"
          type="button"
          *ngIf="isWMS()"
          (click)="onUpdateServiceCapabilities()"
        >
          {{ (isNewOrDuplicated() ? 'serviceEntity.getData' : 'serviceEntity.updateData') | translate }}
        </button>
      </mat-card-content>
    </mat-card>
    <app-data-grid [allNewElements]="isNewOrDuplicated()"
                   [columnDefs]="layersTable.relationsColumnsDefs"
                   [getAll]='layersTable.relationsFetchFn'
                   [eventAddItemsSubscription]='layersTable.addCommandEvent$.asObservable()'
                   [eventGetAllRowsSubscription]='layersTable.saveCommandEvent$.asObservable()'
                   [eventRefreshSubscription]='layersTable.refreshCommandEvent$.asObservable()'
                   [actionButton]=true
                   [discardChangesButton]=true
                   [redoButton]=true
                   [undoButton]=true
                   [deleteButton]=true
                   [addButton]=false
                   [hideDuplicateButton]=true
                   [registerButton]=true
                   [defaultColumnSorting]='layersTable.defaultRelationsSorting()'
                   newStatusRegister="pendingRegistration"
                   (getAllRows)="layersTable.handleSaveRelations($event)"
                   (add)="layersTable.openDialog($event)"
                   *ngIf="dataLoaded">
    </app-data-grid>
  </mat-tab>
  <mat-tab label="{{ 'serviceEntity.configurationParameters' | translate }}">
    <app-data-grid [changeHeightButton]="true"
                   [allNewElements]="isNewOrDuplicated()"
                   [columnDefs]="parametersTable.relationsColumnsDefs"
                   [getAll]='parametersTable.relationsFetchFn'
                   [eventAddItemsSubscription]='parametersTable.addCommandEvent$.asObservable()'
                   [eventGetAllRowsSubscription]='parametersTable.saveCommandEvent$.asObservable()'
                   [eventRefreshSubscription]='parametersTable.refreshCommandEvent$.asObservable()'
                   [actionButton]=true
                   [discardChangesButton]=true
                   [redoButton]=true
                   [undoButton]=true
                   [deleteButton]=true
                   [newButton]=true
                   [defaultColumnSorting]='parametersTable.defaultRelationsSorting()'
                   (getAllRows)="parametersTable.handleSaveRelations($event)"
                   (new)="parametersTable.openTemplateDialog('newParameterDialog')"
                   (duplicate)='duplicateParameters($event)'
                   *ngIf="dataLoaded">
    </app-data-grid>
  </mat-tab>
</mat-tab-group>

<ng-template #newParameterDialog>
  <form [formGroup]="parametersTable.templateDialog('newParameterDialog').form">
    <mat-card appearance="outlined">
      <mat-card-content>
        <mat-form-field appearance="outline" class="full">
          <mat-label>{{ 'applicationEntity.name' | translate }}</mat-label>
          <input matInput type="text" formControlName="name" required [maxlength]="50">
          <mat-hint align="end">{{parametersTable.templateDialog('newParameterDialog').form.get('name') | characterCount}}</mat-hint>
        </mat-form-field>
        <mat-form-field appearance="outline" class="full">
          <mat-label>{{ 'applicationEntity.type' | translate }}</mat-label>
          <mat-select formControlName="type" class="form-control" required>
            <mat-option [value]="parameterType.value" *ngFor="let parameterType of this.codeList('serviceParameter.type')">
              {{ parameterType.description }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field appearance="outline" class="full">
          <mat-label>{{ 'serviceEntity.value' | translate }}</mat-label>
          <input matInput type="text" formControlName="value" required [maxlength]="250">
          <mat-hint align="end">{{parametersTable.templateDialog('newParameterDialog').form.get('value') | characterCount}}</mat-hint>
        </mat-form-field>
      </mat-card-content>
    </mat-card>
  </form>
</ng-template>
