<mat-toolbar>
  <h4>
    <mat-icon aria-hidden="true" svgIcon="menu_servei"></mat-icon>
    <span> {{ "serviceEntity.service" | translate }} - {{ (serviceID === -1 ? "new" : "edit") | translate }}</span>
  </h4>
  <span class="spacer"></span>
  <button
    matTooltip="{{ 'save' | translate }}"
    mat-mini-fab class="add-half-gap"
    (click)="onSaveButtonClicked()">
    <mat-icon fontSet="material-icons-round">save</mat-icon>
  </button>
  <button
    matTooltip="{{ 'return' | translate }}"
    mat-mini-fab class="add-half-gap"
    (click)="utils.navigateBack()">
    <mat-icon fontSet="material-icons-round">arrow_back</mat-icon>
  </button>
</mat-toolbar>
<mat-tab-group
  mat-stretch-tabs="false"
  mat-align-tabs="end"
  [dynamicHeight]="true"
  preserveContent="true"
  (selectedTabChange)="onTabChange($event)">
  >
  <mat-tab label="{{ 'serviceEntity.generalData' | translate }}">
    <form [formGroup]='serviceForm' *ngIf="dataLoaded">
      <mat-card class="sitmun-mat-card-margin" appearance="outlined">
        <mat-card-content>
          <mat-form-field appearance="outline" class="full">
            <mat-label>{{ 'serviceEntity.name' | translate }}</mat-label>
            <input matInput type="text" formControlName="name" required>
          </mat-form-field>
          <mat-form-field appearance="outline" class="full">
            <mat-label>{{ 'serviceEntity.description' | translate }}</mat-label>
            <textarea matInput type="text" formControlName="description" required> </textarea>
            <mat-icon matSuffix class="iconTranslate"
                      (click)="onTranslationButtonClicked()"
                      onKeyDown="onTranslationButtonClicked()"
                      svgIcon="ic_translate"></mat-icon>
          </mat-form-field>
          <mat-checkbox formControlName="blocked">
            {{ 'serviceEntity.available' | translate }}
          </mat-checkbox>
        </mat-card-content>
      </mat-card>

      <mat-card class="sitmun-mat-card-margin" appearance="outlined">
        <mat-card-content>
          <mat-form-field appearance="outline" class="quarter">
            <mat-label>{{ 'serviceEntity.type' | translate }}</mat-label>
            <mat-select formControlName="type" class="form-control" (selectionChange)="onTypeChange($event)" required>
              <mat-option [value]="serviceType.value" *ngFor="let serviceType of serviceTypes">
                {{ serviceType.description }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field appearance="outline" class="full">
            <mat-label>{{ 'serviceEntity.url' | translate }}</mat-label>
            <input matInput type="text" formControlName="serviceURL" required>
          </mat-form-field>
          <mat-form-field appearance="outline" class="full">
            <mat-label>{{ 'serviceEntity.metadataURL' | translate }}</mat-label>
            <input matInput type="text" formControlName="getInformationURL">
          </mat-form-field>
          <mat-form-field appearance="outline" class="full">
            <mat-label>{{ 'serviceEntity.projections' | translate }}</mat-label>
            <mat-chip-grid #chipList aria-label="Selecció de projecció">
              <mat-chip-row
                *ngFor="let projection of projections"
                [removable]="removable"
                (removed)="removeProjection(projection)">
                {{ projection }}
                <button matChipRemove>
                  <mat-icon>cancel</mat-icon>
                </button>
              </mat-chip-row>
              <input
                [matChipInputFor]="chipList"
                [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                [matChipInputAddOnBlur]="addOnBlur"
                (matChipInputTokenEnd)="addProjection($event)"/>
            </mat-chip-grid>
          </mat-form-field>
          <mat-checkbox formControlName="isProxied">
            {{ 'serviceEntity.proxied' | translate }}
          </mat-checkbox>
        </mat-card-content>
      </mat-card>

      <mat-card class="sitmun-mat-card-margin" appearance="outlined">
        <mat-card-content>
          <mat-form-field appearance="outline" class="quarter">
            <mat-label>{{ 'serviceEntity.authenticationMode' | translate }}</mat-label>
            <mat-select formControlName="authenticationMode" class="form-control" required>
              <mat-option [value]="mode.value" *ngFor="let mode of authenticationModes">
                {{ mode.description }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <div class="break"></div>
          <mat-form-field appearance="outline"
                          *ngIf=" isAuthenticationModeNode()"
                          class="half add-gap"
          >
            <mat-label>{{ 'serviceEntity.user' | translate }}</mat-label>
            <input matInput type="text" formControlName="user">
          </mat-form-field>
          <mat-form-field appearance="outline"
                          *ngIf="isAuthenticationModeNode()"
                          class="half"
          >
            <mat-label>{{ 'serviceEntity.password' | translate }}</mat-label>
            <input matInput [type]="'text'" formControlName="password">
          </mat-form-field>
        </mat-card-content>
      </mat-card>
    </form>
  </mat-tab>
  <mat-tab label="{{ 'serviceEntity.layersToRegister' | translate }}">
    <mat-card appearance="outlined">
      <mat-card-content>
        <button
          mat-raised-button
          class="sitmun-mat-button-margin sitmun-action-button"
          id="capabilitiesButton"
          type="button"
          *ngIf="isWMS()"
          (click)="onDataCapabilitiesButtonClicked()"
        >
          {{ (serviceID === -1 ? 'serviceEntity.getData' : 'serviceEntity.updateData') | translate }}
        </button>
      </mat-card-content>
    </mat-card>
    <app-data-grid [allNewElements]="serviceID === -1"
                   [columnDefs]="columnDefsLayers"
                   [getAll]='getAllLayers'
                   [eventAddItemsSubscription]='addElementsEventLayers.asObservable()'
                   [eventGetAllRowsSubscription]='getAllElementsEventLayers.asObservable()'
                   [eventRefreshSubscription]='dataUpdatedEventLayers.asObservable()'
                   [discardChangesButton]=true
                   [redoButton]=true
                   [undoButton]=true
                   [deleteButton]=true
                   [addButton]=false
                   [hideDuplicateButton]=true
                   [registerButton]=true
                   newStatusRegister="pendingRegistration"
                   (load)="onTableLoadButtonClicked()"
                   (getAllRows)="getAllRowsLayers($event)"
                   [actionButton]=true
                   (add)="openCartographyDialog()"
                   [redraw]="activeTabIndex === 1"
                   *ngIf="dataLoaded">
    </app-data-grid>
  </mat-tab>
  <mat-tab label="{{ 'serviceEntity.configurationParameters' | translate }}">
    <app-data-grid [changeHeightButton]="true"
                   [allNewElements]="serviceID === -1"
                   [columnDefs]="columnDefsParameters"
                   [getAll]='getAllParameters'
                   [eventAddItemsSubscription]='addElementsEventParameters.asObservable()'
                   [eventGetAllRowsSubscription]='getAllElementsEventParameters.asObservable()'
                   [eventRefreshSubscription]='dataUpdatedEventParameters.asObservable()'
                   [discardChangesButton]=true
                   [redoButton]=true
                   [undoButton]=true
                   [deleteButton]=true
                   [newButton]=true
                   addFieldRestriction="name"
                   (getAllRows)="getAllRowsParameters($event)"
                   [defaultColumnSorting]="['type','name']"
                   [actionButton]=true
                   (duplicate)='duplicateParameters($event)'
                   (new)="openParametersDialog()"
                   [redraw]="activeTabIndex === 2"
                   *ngIf="dataLoaded">
    </app-data-grid>
  </mat-tab>
</mat-tab-group>

<ng-template #newParameterDialog>
  <form [formGroup]='parameterForm'>
    <mat-card appearance="outlined">
      <mat-card-content>
        <mat-form-field appearance="outline" class="full">
          <mat-label>{{ 'serviceEntity.request' | translate }}</mat-label>
          <mat-select formControlName="type" class="form-control" required>
            <mat-option [value]="requestType.value" *ngFor="let requestType of requestTypes">
              {{ requestType.description }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field appearance="outline" class="full">
          <mat-label>{{ 'serviceEntity.parameter' | translate }}</mat-label>
          <input matInput type="text" formControlName="name" required>
        </mat-form-field>
        <mat-form-field appearance="outline" class="full">
          <mat-label>{{ 'serviceEntity.value' | translate }}</mat-label>
          <input matInput type="text" formControlName="value">
        </mat-form-field>
      </mat-card-content>
    </mat-card>
  </form>
</ng-template>
