<mat-toolbar>
  <h4>
    <mat-icon aria-hidden="true" svgIcon="menu_usuari"></mat-icon>
    <span> {{ "userEntity.user" | translate }}-{{ (userID === -1 ? "new" : "edit") | translate }}</span>
  </h4>
</mat-toolbar>

<div *ngIf="dataLoaded">
  <form [formGroup]='userForm'>
    <mat-card class="sitmun-mat-card-margin" appearance="outlined">
      <mat-card-header class="sitmun-form-title">
        <mat-card-title>
          {{ 'serviceEntity.generalData' | translate }}
        </mat-card-title>
      </mat-card-header>
      <mat-card-actions align="end">
        <button mat-flat-button type="submit" class="sitmun-save-button" (click)="onSaveButtonClicked()">
          <mat-icon fontSet="material-icons-round">save</mat-icon>
          {{ "save" | translate }}
        </button>
        <button mat-flat-button type="button" class="sitmun-return-button" (click)="utils.navigateBack()">
          <mat-icon fontSet="material-icons-round">arrow_back</mat-icon>
          {{ "return" | translate }}
        </button>
      </mat-card-actions>
      <mat-card-content>
        <mat-card class="sitmun-mat-card-margin" appearance="outlined">
          <mat-card-content>
            <!-- User name -->
            <mat-form-field appearance="outline" class="quarter">
              <mat-label>{{ 'userEntity.user' | translate }}</mat-label>
              <input matInput type="text" formControlName="username" [readonly]="isUsernamePublic()">
            </mat-form-field>
            <div class="break"></div>
            <!-- Blocked -->
            <mat-checkbox formControlName="blocked">
              {{ 'userEntity.blocked' | translate }}
            </mat-checkbox>
          </mat-card-content>
        </mat-card>
        <mat-card class="sitmun-mat-card-margin" appearance="outlined" *ngIf="!isUsernamePublic()">
          <mat-card-content>
            <!-- First name -->
            <mat-form-field appearance="outline" class="half add-gap">
              <mat-label>{{ 'userEntity.firstname' | translate }}</mat-label>
              <input matInput type="text" formControlName="firstName">
            </mat-form-field>
            <!-- Last name -->
            <mat-form-field appearance="outline" class="half">
              <mat-label>{{ 'userEntity.lastname' | translate }}</mat-label>
              <input matInput type="text" formControlName="lastName">
            </mat-form-field>
            <!-- Password -->
            <mat-form-field appearance="outline" class="half add-gap">
              <mat-label>{{ 'userEntity.password' | translate }}</mat-label>
              <input matInput [type]="'password'"
                     formControlName="password"
                    (input)="onPasswordChange()"
                    (focus)="resetPasswordField()">
            </mat-form-field>
            <div class="break"></div>
            <!-- Administrator -->
            <mat-checkbox formControlName="administrator">
              {{ 'userEntity.administrator' | translate }}
            </mat-checkbox>
          </mat-card-content>
        </mat-card>
      </mat-card-content>
    </mat-card>
  </form>

  <mat-accordion multi>

    <!-- Permits table -->
    <mat-expansion-panel [expanded]="true" class="sitmun-ag-grid-expansion-panel">
      <mat-expansion-panel-header class="sitmun-ag-grid-expansion-panel-title">
        <mat-panel-title>
          {{ "userEntity.permissions" | translate }}
        </mat-panel-title>
      </mat-expansion-panel-header>

      <ng-template matExpansionPanelContent>
        <div class="sitmun-app-data-grid-edit">
          <app-data-grid [changeHeightButton]="true"
                         [allNewElements]="userID === -1"
                         [columnDefs]="columnDefsPermits"
                         defaultColumnSorting="territory"
                         [themeGrid]='themeGrid'
                         [getAll]='getAllPermits'
                         [eventAddItemsSubscription]='addElementsEventPermits.asObservable()'
                         [eventGetAllRowsSubscription]='getAllElementsEventPermits.asObservable()'
                         [eventRefreshSubscription]='dataUpdatedEventPermits.asObservable()'
                         [discardChangesButton]=true
                         [actionButton]=true
                         [redoButton]=true
                         [undoButton]=true
                         [deleteButton]=true
                         [addButton]=true
                         [addFieldRestriction]="['territoryId', 'roleId', 'userId']"
                         (getAllRows)="getAllRowsPermits($event)"
                         (add)="openPermitsDialog()"
          ></app-data-grid>
        </div>
      </ng-template>
    </mat-expansion-panel>

    <!-- Territory data table -->
    <mat-expansion-panel [expanded]="true" class="sitmun-ag-grid-expansion-panel">
      <mat-expansion-panel-header class="sitmun-ag-grid-expansion-panel-title">
        <mat-panel-title>
          {{ "userEntity.dataOfTerritory" | translate }}
        </mat-panel-title>
      </mat-expansion-panel-header>

      <ng-template matExpansionPanelContent>
        <div class="sitmun-app-data-grid-edit">
          <app-data-grid [changeHeightButton]="true"
                         [allNewElements]="userID === -1"
                         [columnDefs]="columnDefsData"
                         [themeGrid]='themeGrid'
                         [getAll]='getAllDataTerritory'
                         [eventAddItemsSubscription]='addElementsEventTerritoryData.asObservable()'
                         [eventGetAllRowsSubscription]='getAllElementsEventTerritoryData.asObservable()'
                         [eventRefreshSubscription]='dataUpdatedEventTerritoryData.asObservable()'
                         [discardChangesButton]=true
                         [actionButton]=true
                         [deleteButton]=true
                         [redoButton]=true
                         [undoButton]=true
                         [hideDuplicateButton]=true
                         defaultColumnSorting="territoryName"
                         (getAllRows)="getAllRowsDataTerritories($event)"
          ></app-data-grid>
          <!-- TODO Add position data dialog -->
        </div>
      </ng-template>
    </mat-expansion-panel>
  </mat-accordion>
</div>
