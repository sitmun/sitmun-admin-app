<app-form-toolbar
  icon="menu_aplicacio"
  entityType="applicationEntity.application"
  [itemName]="applicationForm?.get('name')?.value || ''"
  [isNew]="applicationID === -1"
  (save)="onSaveButtonClicked()"
  (back)="utils.navigateBack()">
</app-form-toolbar>

<mat-tab-group
  mat-stretch-tabs="false"
  mat-align-tabs="end"
  [dynamicHeight]="true"
  preserveContent="true"
  (selectedTabChange)="onTabChange($event)">
  >
  <mat-tab label="{{ 'roleEntity.generalData' | translate }}">
    <form [formGroup]='applicationForm' *ngIf="dataLoaded">
      <mat-card class="sitmun-mat-card-margin" appearance="outlined">
        <mat-card-content>
          <mat-form-field appearance="outline" class="full">
            <mat-label>{{ 'applicationEntity.name' | translate }}</mat-label>
            <input matInput type="text" formControlName="name" [maxlength]="50" required>
            <mat-hint align="end" [class.text-warning]="applicationForm.get('name')?.value?.length > 50">
              {{applicationForm.get('name') | characterCount}}
              <mat-icon *ngIf="applicationForm.get('name')?.value?.length > 50" fontIcon="warning" class="warning-icon"></mat-icon>
            </mat-hint>
          <mat-icon matSuffix class="iconTranslate"
                      (click)="onTranslated('name')"
                      onKeyDown="onTranslated('name')"
                      svgIcon="ic_translate"></mat-icon>
          </mat-form-field>
          <mat-form-field appearance="outline" class="full">
            <mat-label>{{ 'applicationEntity.description' | translate }}</mat-label>
            <textarea matInput type="text" formControlName="description" required [maxlength]="4000"></textarea>
              <mat-hint align="end">{{applicationForm.get('description') | characterCount}}</mat-hint>
              <mat-icon matSuffix class="iconTranslate"
                      (click)="onTranslated('description')"
                      onKeyDown="onTranslated('description')"
                      svgIcon="ic_translate"></mat-icon>
          </mat-form-field>
          <mat-form-field appearance="outline" class="quarter">
            <mat-label>{{ 'applicationEntity.type' | translate }}</mat-label>
            <mat-select formControlName="type" class="form-control"
                        (selectionChange)="onSelectionTypeAppChanged($event)">
              <mat-option [value]="appType.value" *ngFor="let appType of this.codeList('application.type')">
                {{ appType.description }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field appearance="outline" class="full">
            <mat-label>{{ 'applicationEntity.logo' | translate }}</mat-label>
            <input matInput type="text" formControlName="logo" [maxlength]="4000">
            <mat-hint align="end">{{applicationForm.get('logo') | characterCount}}</mat-hint>
          </mat-form-field>
        </mat-card-content>
      </mat-card>
      <mat-card class="sitmun-mat-card-margin" appearance="outlined"
                *ngIf="applicationForm.value.type===codeValues.applicationType.externalApp">
        <mat-card-content>
          <mat-form-field appearance="outline" class="full">
            <mat-label>{{ 'applicationEntity.url' | translate }}</mat-label>
            <input matInput type="text" formControlName="jspTemplate" [maxlength]="250">
            <mat-hint align="end">{{applicationForm.get('jspTemplate') | characterCount}}</mat-hint>
          </mat-form-field>
        </mat-card-content>
      </mat-card>
      <mat-card class="sitmun-mat-card-margin" appearance="outlined"
                *ngIf="applicationForm.value.type===codeValues.applicationType.internalApp">
        <mat-card-content>
          <mat-form-field appearance="outline" class="full">
            <mat-label>{{ 'applicationEntity.title' | translate }}</mat-label>
            <input matInput type="text" formControlName="title" [maxlength]="250">
            <mat-icon matSuffix class="iconTranslate"
                      (click)="onTranslated('title')"
                      onKeyDown="onTranslated('title')"
                      svgIcon="ic_translate"></mat-icon>
            <mat-hint align="end">{{applicationForm.get('title') | characterCount}}</mat-hint>
          </mat-form-field>
          <mat-form-field appearance="outline" class="half add-gap">
            <mat-label>{{ 'applicationEntity.CSS' | translate }}</mat-label>
            <input matInput type="text" formControlName="theme" [maxlength]="30">
            <mat-hint align="end">{{applicationForm.get('theme') | characterCount}}</mat-hint>
          </mat-form-field>
          <mat-form-field appearance="outline" class="half">
            <mat-label>{{ 'applicationEntity.scales' | translate }}</mat-label>
            <input matInput type="text" formControlName="scales" [maxlength]="250">
            <mat-hint align="end">{{applicationForm.get('scales') | characterCount}}</mat-hint>
          </mat-form-field>
          <mat-form-field appearance="outline" class="half add-gap">
            <mat-label>{{ 'applicationEntity.srs' | translate }}</mat-label>
            <input matInput type="text" formControlName="srs" [maxlength]="50">
            <mat-hint align="end">{{applicationForm.get('srs') | characterCount}}</mat-hint>
          </mat-form-field>
          <mat-form-field appearance="outline" class="half">
            <mat-label>{{ 'applicationEntity.situationMap' | translate }}</mat-label>
            <mat-select formControlName="situationMap" class="form-control">
              <mat-option [value]="situationMapObj.id" *ngFor="let situationMapObj of situationMapList">
                {{ situationMapObj.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <div class="break"></div>
          <mat-checkbox formControlName="accessParentTerritory">
            <mat-label>{{ 'applicationEntity.accessParentTerritory' | translate }}</mat-label>
          </mat-checkbox>
          <mat-checkbox formControlName="accessChildrenTerritory">
            <mat-label>{{ 'applicationEntity.accessChildrenTerritory' | translate }}</mat-label>
          </mat-checkbox>
          <div class="break"></div>
          <mat-checkbox formControlName="treeAutoRefresh">
            <mat-label>{{ 'applicationEntity.treeAutoRefresh' | translate }}</mat-label>
          </mat-checkbox>
        </mat-card-content>
      </mat-card>
    </form>
  </mat-tab>
  <mat-tab label="{{ 'applicationEntity.parametersConfiguration' | translate }}">
    <app-data-grid [changeHeightButton]="true"
                   [allNewElements]="applicationID === -1"
                   [columnDefs]="columnDefsParameters"
                   [getAll]='fetchParameters'
                   [eventAddItemsSubscription]='addElementsEventParameters.asObservable()'
                   [eventGetAllRowsSubscription]='getAllElementsEventParameters.asObservable()'
                   [eventRefreshSubscription]='dataUpdatedEventParameters.asObservable()'
                   [discardChangesButton]=true
                   [actionButton]=true
                   [redoButton]=true
                   [undoButton]=true
                   [deleteButton]=true
                   [newButton]=true
                   addFieldRestriction="name"
                   [defaultColumnSorting]="['name']"
                   (new)="openParametersDialog()"
                   (getAllRows)="handleParametersEvent($event)"
                   (duplicate)='duplicateParameters($event)'
                   [redraw]="activeTabIndex === 1"
                   *ngIf="dataLoaded"
    ></app-data-grid>
  </mat-tab>
  <mat-tab label="{{ 'applicationEntity.roles' | translate }}">
    <app-data-grid [changeHeightButton]="true"
                   [allNewElements]="applicationID === -1"
                   [columnDefs]="columnDefsRoles"
                   [getAll]='fetchRoles'
                   [eventAddItemsSubscription]='addElementsEventRoles.asObservable()'
                   [eventGetAllRowsSubscription]='getAllElementsEventRoles.asObservable()'
                   [eventRefreshSubscription]='dataUpdatedEventRoles.asObservable()'
                   [actionButton]=true
                   [discardChangesButton]=true
                   [redoButton]=true
                   [undoButton]=true
                   [deleteButton]=true
                   [addButton]=true
                   [defaultColumnSorting]="['name']"
                   [hideDuplicateButton]=true
                   (getAllRows)="handleRolesEvent($event)"
                   (add)="openRolesDialog($event)"
                   [redraw]="activeTabIndex === 2"
                   *ngIf="dataLoaded"
    ></app-data-grid>
  </mat-tab>
  <mat-tab label="{{ 'applicationEntity.background' | translate }}">
    <app-data-grid [changeHeightButton]="true"
                   [allNewElements]="applicationID === -1"
                   [columnDefs]="columnDefsApplicationBackgrounds"
                   [getAll]='fetchApplicationBackgrounds'
                   [eventAddItemsSubscription]='addElementsEventApplicationBackground.asObservable()'
                   [eventGetAllRowsSubscription]='getAllElementsEventApplicationBackground.asObservable()'
                   [eventRefreshSubscription]='dataUpdatedEventApplicationBackground.asObservable()'
                   [actionButton]=true
                   [discardChangesButton]=true
                   [redoButton]=true
                   [undoButton]=true
                   [deleteButton]=true
                   [addButton]=true
                   [hideDuplicateButton]=true
                   [defaultColumnSorting]="['order']"
                   (getAllRows)="handleApplicationBackgroundsEvent($event)"
                   (add)="openBackgroundDialog($event)"
                   [redraw]="activeTabIndex === 3"
                   *ngIf="dataLoaded"
    ></app-data-grid>
  </mat-tab>
  <mat-tab label="{{ 'applicationEntity.tree' | translate }}">
    <app-data-grid #treesDataGrid
                   [changeHeightButton]="true"
                   [allNewElements]="applicationID === -1"
                   [columnDefs]="columnDefsTrees"
                   [getAll]='fetchTrees'
                   [eventAddItemsSubscription]='addElementsEventTree.asObservable()'
                   [eventGetAllRowsSubscription]='getAllElementsEventTree.asObservable()'
                   [eventRefreshSubscription]='dataUpdatedEventTrees.asObservable()'
                   [actionButton]=true
                   [discardChangesButton]=true
                   [redoButton]=true
                   [undoButton]=true
                   [deleteButton]=true
                   [addButton]=true
                   [hideDuplicateButton]=true
                   [defaultColumnSorting]="['name']"
                   (getAllRows)="handleTreesEvent($event)"
                   (add)="openTreeDialog($event)"
                   [redraw]="activeTabIndex === 4"
                   *ngIf="dataLoaded"
    ></app-data-grid>
  </mat-tab>
</mat-tab-group>

<ng-template #newParameterDialog>
  <form [formGroup]='parameterForm'>
    <mat-card appearance="outlined">
      <mat-card-content>
        <mat-form-field appearance="outline" class="full">
          <mat-label>{{ 'applicationEntity.name' | translate }}</mat-label>
          <input matInput type="text" formControlName="name" required [maxlength]="50">
          <mat-hint align="end">{{parameterForm.get('name') | characterCount}}</mat-hint>
        </mat-form-field>
        <mat-form-field appearance="outline" class="full">
          <mat-label>{{ 'applicationEntity.type' | translate }}</mat-label>
          <mat-select formControlName="type" class="form-control" required>
            <mat-option [value]="parameterType.value" *ngFor="let parameterType of this.codeList('applicationParameter.type')">
              {{ parameterType.description }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field appearance="outline" class="full">
          <mat-label>{{ 'serviceEntity.value' | translate }}</mat-label>
          <input matInput type="text" formControlName="value" required [maxlength]="250">
          <mat-hint align="end">{{parameterForm.get('value') | characterCount}}</mat-hint>
        </mat-form-field>
      </mat-card-content>
    </mat-card>
  </form>
</ng-template>
