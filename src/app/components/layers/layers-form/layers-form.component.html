<mat-toolbar>
  <h4>
    <mat-icon aria-hidden="true" svgIcon="menu_capes"></mat-icon>
    <span class="spacer"> {{ "layersEntity.layers" | translate }}
      - {{ (layerID === -1 ? "new" : "edit") | translate }}</span>
  </h4>
  <span class="spacer"></span>
  <button
    matTooltip="{{ 'save' | translate }}"
    mat-mini-fab class="add-half-gap"
    (click)="onSaveButtonClicked()">
    <mat-icon fontSet="material-icons-round">save</mat-icon>
  </button>
  <button
    matTooltip="{{ 'return' | translate }}"
    mat-mini-fab class="add-half-gap"
    (click)="utils.navigateBack()">
    <mat-icon fontSet="material-icons-round">arrow_back</mat-icon>
  </button>
</mat-toolbar>
<form [formGroup]='layerForm' *ngIf="dataLoaded">
  <mat-tab-group
    mat-stretch-tabs="false"
    mat-align-tabs="end"
    [dynamicHeight]="true"
    preserveContent="true"
    (selectedTabChange)="onTabChange($event)">
    >
    <mat-tab label="{{ 'layersEntity.generalData' | translate }}">
      <mat-card class="sitmun-mat-card-margin" appearance="outlined">
        <mat-card-content>
          <mat-form-field appearance="outline" class="full">
            <mat-label>{{ 'layersEntity.name' | translate }}</mat-label>
            <input matInput type="text" formControlName="name" required>
          </mat-form-field>
          <mat-form-field appearance="outline" class="full">
            <mat-label>{{ 'layersEntity.description' | translate }}</mat-label>
            <textarea matInput type="text" formControlName="description"> </textarea>
            <mat-icon matSuffix class="iconTranslate"
                      (click)="onTranslationButtonClicked()"
                      onKeyDown="onTranslationButtonClicked()"
                      svgIcon="ic_translate"></mat-icon>
          </mat-form-field>
          <mat-checkbox formControlName="blocked">
            {{ 'layersEntity.available' | translate }}
          </mat-checkbox>
          <div class="break"></div>
          <mat-form-field appearance="outline" class="full">
            <mat-label>{{ 'layersEntity.layers' | translate }}</mat-label>
            <input matInput type="text" formControlName="layers" required>
          </mat-form-field>
          <mat-form-field appearance="outline" class="quarter add-gap">
            <mat-label>{{ 'layersEntity.minimumScale' | translate }}</mat-label>
            <input matInput type="number" formControlName="minimumScale">
          </mat-form-field>
          <mat-form-field appearance="outline" class="quarter add-gap">
            <mat-label>{{ 'layersEntity.maximumScale' | translate }}</mat-label>
            <input matInput type="number" formControlName="maximumScale">
          </mat-form-field>
          <div class="break"></div>
          <mat-form-field appearance="outline" class="quarter add-gap">
            <mat-label>{{ 'layersEntity.order' | translate }}</mat-label>
            <input matInput type="number" formControlName="order">
          </mat-form-field>
          <mat-form-field appearance="outline" class="quarter add-gap">
            <mat-label>{{ 'layersEntity.transparency' | translate }}</mat-label>
            <input matInput type="number" formControlName="transparency">
          </mat-form-field>
          <mat-form-field appearance="outline" class="quarter">
            <mat-label>{{ 'layersEntity.source' | translate }}</mat-label>
            <input matInput type="text" formControlName="source">
          </mat-form-field>
          <div class="break"></div>
          <mat-form-field appearance="outline" class="half">
            <mat-label>{{ 'layersEntity.legendType' | translate }}</mat-label>
            <mat-select formControlName="legendType">
              <mat-option [value]="legendType.value" *ngFor="let legendType of legendTypes">
                {{ legendType.description }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <div class="break"></div>
          <mat-form-field appearance="outline" class="half">
            <mat-label>{{ 'layersEntity.serviceName' | translate }}</mat-label>
            <mat-select formControlName="service">
              <mat-option [value]="service.id" *ngFor="let service of services">
                {{ service.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field appearance="outline" class="full">
            <mat-label>{{ 'layersEntity.legendUrl' | translate }}</mat-label>
            <input matInput type="text" formControlName="legendUrl">
          </mat-form-field>
          <mat-form-field appearance="outline" class="full">
            <mat-label>{{ 'layersEntity.datasetURL' | translate }}</mat-label>
            <input matInput type="text" formControlName="datasetURL">
          </mat-form-field>
          <mat-form-field appearance="outline" class="full">
            <mat-label>{{ 'serviceEntity.metadataURL' | translate }}</mat-label>
            <input matInput type="text" formControlName="metadataURL">
          </mat-form-field>
          <mat-checkbox formControlName="useAllStyles">
            {{ 'layersEntity.useAllStyles' | translate }}
          </mat-checkbox>
        </mat-card-content>
      </mat-card>
    </mat-tab>
    <mat-tab label="{{ 'layersEntity.spatialSelection' | translate }}">
      <mat-card appearance="outlined">
        <mat-card-content>
          <mat-checkbox formControlName="selectableFeatureEnabled" (change)="onSelectableFeatureEnabledChange($event)">
            {{ 'layersEntity.selectable' | translate }}
          </mat-checkbox>
          <div class="break"></div>
          <mat-form-field appearance="outline" class="half add-gap">
            <mat-label>{{ 'layersEntity.service' | translate }}</mat-label>
            <mat-select formControlName="spatialSelectionService" (selectionChange)="loadButtonDisabled()"
            >
              <mat-option [value]="service.id" *ngFor="let service of spatialConfigurationServices">
                {{ service.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field appearance="outline" class="half">
            <mat-label>{{ 'layersEntity.layer' | translate }}</mat-label>
            <input matInput type="text" formControlName="selectableLayers" (keyup)="loadButtonDisabled()" required>
          </mat-form-field>
          <div class="break"></div>
          <button
            mat-raised-button
            class="sitmun-mat-button-margin sitmun-action-button"
            (click)="onLoadButtonClicked()" [disabled]="disableLoadButton">
            {{ "layersEntity.load" | translate }}
          </button>
          <div class="break"></div>
          <mat-form-field appearance="outline" class="half">
            <mat-label>{{ 'layersEntity.connection' | translate }}</mat-label>
            <mat-select formControlName="spatialSelectionConnection">
              <mat-option [value]="connection.name" *ngFor="let connection of spatialConfigurationConnections">
                {{ connection.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </mat-card-content>
      </mat-card>
      <app-data-grid [changeHeightButton]="true" [allNewElements]="layerID === -1"
                     [columnDefs]="columnDefsSpatialConfigurations"
                     [getAll]='getAllSpatialConfigurations' [defaultColumnSorting]="['name']"
                     [eventAddItemsSubscription]='addElementsEventSpatialConfigurations.asObservable()'
                     [eventGetAllRowsSubscription]='getAllElementsEventSpatialConfigurations.asObservable()'
                     [eventRefreshSubscription]='dataUpdatedEventSpatialConfigurations.asObservable()'
                     [eventReplaceAllItemsSubscription]='replaceAllElementsEventSpatialConfigurations.asObservable()'
                     [discardChangesButton]=true [redoButton]=true [undoButton]=true [deleteButton]=true
                     [newButton]=true
                     (getAllRows)="getAllRowsParameters($event, true)" [actionButton]=true
                     addFieldRestriction="name"
                     [redraw]="activeTabIndex === 1"
                     (duplicate)='duplicateParameters($event, true)' (new)="openSpatialSelectionDialog($event)">
      </app-data-grid>
    </mat-tab>
    <mat-tab label="{{ 'layersEntity.parametersConfiguration' | translate }}">
      <mat-card appearance="outlined">
        <mat-card-content>
          <mat-checkbox formControlName="queryableFeatureEnabled" (change)="onQueryableFeatureEnabledChange($event)">
            {{ 'layersEntity.information' | translate }}
          </mat-checkbox>
          <mat-checkbox formControlName="queryableFeatureAvailable">
            {{ 'layersEntity.defaultInformation' | translate }}
          </mat-checkbox>
          <div class="break"></div>
          <mat-form-field appearance="outline" class="half and-gap">
            <mat-label>{{ 'layersEntity.informationLayer' | translate }}</mat-label>
            <input matInput type="text" formControlName="queryableLayers" required>
          </mat-form-field>
          <div class="break"></div>
          <mat-checkbox
            formControlName="thematic"
            (change)="onSelectionThematicChanged($event)">
            {{ 'layersEntity.thematic' | translate }}
          </mat-checkbox>
          <div class="break"></div>
          <mat-form-field appearance="outline" class="half">
            <mat-label>{{ 'layersEntity.geometryType' | translate }}</mat-label>
            <mat-select formControlName="geometryType">
              <mat-option [value]="geometryType.value" *ngFor="let geometryType of geometryTypes">
                {{ geometryType.description }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </mat-card-content>
      </mat-card>
      <app-data-grid [changeHeightButton]="true"
                     [allNewElements]="layerID === -1"
                     [columnDefs]="columnDefsParameters"
                     [getAll]='getAllParameters'
                     [eventAddItemsSubscription]='addElementsEventParameters.asObservable()'
                     [defaultColumnSorting]="['name']"
                     [eventGetAllRowsSubscription]='getAllElementsEventParameters.asObservable()'
                     [eventRefreshSubscription]='dataUpdatedEventParameters.asObservable()'
                     [discardChangesButton]=true
                     [redoButton]=true [undoButton]=true [deleteButton]=true [newButton]=true
                     addFieldRestriction="name"
                     (getAllRows)="getAllRowsParameters($event, false)"
                     [actionButton]=true
                     (duplicate)='duplicateParameters($event, false)'
                     [redraw]="activeTabIndex === 2"
                     (new)="openParametersDialog($event)">
      </app-data-grid>
    </mat-tab>
    <mat-tab label="{{ 'layersEntity.filters' | translate }}">
      <mat-card appearance="outlined">
        <mat-card-content>
          <mat-checkbox formControlName="applyFilterToGetMap">
            {{ 'layersEntity.applyFilterToGetMap' | translate }}
          </mat-checkbox>
          <mat-checkbox formControlName="applyFilterToGetFeatureInfo">
            {{ 'layersEntity.filterInfoByMunicipality' | translate }}
          </mat-checkbox>
          <mat-checkbox formControlName="applyFilterToSpatialSelection">
            {{ 'layersEntity.filterSpatialSelectionByMunicipality' | translate }}
          </mat-checkbox>
        </mat-card-content>
      </mat-card>
      <app-data-grid [changeHeightButton]="true" [allNewElements]="layerID === -1"
                     [columnDefs]="columnDefsTerritorialFilter"
                     [getAll]='getAllTerritorialFilters'
                     [eventAddItemsSubscription]='addElementsTerritorialFilter.asObservable()'
                     defaultColumnSorting="name"
                     [eventGetAllRowsSubscription]='getAllElementsTerritorialFilter.asObservable()'
                     [eventRefreshSubscription]='dataUpdatedEventTerritorialFilter.asObservable()'
                     [discardChangesButton]=true
                     [redoButton]=true [undoButton]=true [deleteButton]=true [newButton]=true
                     (getAllRows)="getAllRowsTerritorialFilters($event)" [actionButton]=true
                     (duplicate)='duplicateTerritorialFilters($event)'
                     [redraw]="activeTabIndex === 3"
                     (new)="openTerritorialFilterDialog($event)"
      >
      </app-data-grid>
    </mat-tab>
    <mat-tab label="{{ 'layersEntity.styles' | translate }}">
      <app-data-grid [changeHeightButton]="true" [allNewElements]="layerID === -1" [columnDefs]="columnDefsStyles"
                     [getAll]='getAllStyles'
                     [eventAddItemsSubscription]='addElementsEventStyles.asObservable()' defaultColumnSorting="name"
                     [eventGetAllRowsSubscription]='getAllElementsEventStyles.asObservable()'
                     [eventRefreshSubscription]='dataUpdatedEventStyles.asObservable()' [discardChangesButton]=true
                     [redoButton]=true [undoButton]=true [deleteButton]=true [newButton]=true
                     addFieldRestriction="name"
                     (getAllRows)="getAllRowsStyles($event)" defaultColumnSorting="order" [actionButton]=true
                     [redraw]="activeTabIndex === 4"
                     (duplicate)='duplicateStyles($event)' (new)="openStylesDialog($event)"
      >
      </app-data-grid>
    </mat-tab>
    <mat-tab label="{{ 'layersEntity.territory' | translate }}">
      <app-data-grid [changeHeightButton]="true" [allNewElements]="layerID === -1"
                     [columnDefs]="columnDefsTerritories" [getAll]='getAllTerritories'
                     [eventAddItemsSubscription]='addElementsEventTerritories.asObservable()'
                     [eventGetAllRowsSubscription]='getAllElementsEventTerritories.asObservable()'
                     addFieldRestriction='territoryId'
                     [eventRefreshSubscription]='dataUpdatedEventTerritories.asObservable()'
                     [discardChangesButton]=true
                     [redoButton]=true [undoButton]=true defaultColumnSorting="territoryName" [deleteButton]=true
                     [addButton]=true [hideDuplicateButton]=true
                     (getAllRows)="getAllRowsTerritories($event)" [actionButton]=true
                     [redraw]="activeTabIndex === 5"
                     (add)="openTerritoriesDialog($event)">
      </app-data-grid>
    </mat-tab>
    <mat-tab label="{{ 'layersEntity.permissiongroupLayersConfiguration' | translate }}">
      <app-data-grid [changeHeightButton]="true" [allNewElements]="layerID === -1"
                     [columnDefs]="columnDefsLayersConfiguration"
                     [getAll]='getAllLayersConfiguration' [defaultColumnSorting]="['name']"
                     [eventAddItemsSubscription]='addElementsEventCartographyGroups.asObservable()'
                     [eventGetAllRowsSubscription]='getAllElementsEventLayersConfigurations.asObservable()'
                     [eventRefreshSubscription]='dataUpdatedEventLayersConfiguration.asObservable()'
                     [discardChangesButton]=true
                     [redoButton]=true [undoButton]=true [deleteButton]=true [addButton]=true
                     [hideDuplicateButton]=true
                     (getAllRows)="getAllRowsLayersConfiguration($event)" [actionButton]=true
                     [redraw]="activeTabIndex === 6"
                     (add)="openCartographyGroupsDialog($event)">
      </app-data-grid>
    </mat-tab>
    <mat-tab label="{{ 'layersEntity.nodes' | translate }}">
      <app-data-grid [changeHeightButton]="true" [allNewElements]="layerID === -1" [columnDefs]="columnDefsNodes"
                     [getAll]='getAllNodes'
                     [eventAddItemsSubscription]='addElementsEventNodes.asObservable()'
                     [defaultColumnSorting]="['name','treeName']"
                     [eventGetAllRowsSubscription]='getAllElementsEventNodes.asObservable()'
                     [eventRefreshSubscription]='dataUpdatedEventNodes.asObservable()' [discardChangesButton]=false
                     [redoButton]=true [undoButton]=true [addButton]=false [hideDuplicateButton]=true
                     (getAllRows)="getAllRowsNodes($event)" [actionButton]=false
                     [redraw]="activeTabIndex === 7"
                     (add)="openNodesDialog($event)">
      </app-data-grid>
    </mat-tab>
  </mat-tab-group>
</form>


<ng-template #newParameterDialog>
  <form [formGroup]='parameterForm'>
    <mat-form-field appearance="outline" class="full">
      <mat-label>{{ 'layersEntity.field' | translate }}</mat-label>
      <input matInput type="text" formControlName="name" required>
    </mat-form-field>

    <mat-form-field appearance="outline" class="full">
      <mat-label>{{ 'layersEntity.alias' | translate }}</mat-label>
      <input matInput type="text" formControlName="value" required>
    </mat-form-field>
    <mat-form-field appearance="outline" class="full">
      <mat-label>{{ 'layersEntity.format' | translate }}</mat-label>
      <mat-select formControlName="format">
        <mat-option [value]="formatType.value" *ngFor="let formatType of parameterFormatTypes">
          {{ formatType.description }}
        </mat-option>
      </mat-select>
    </mat-form-field>
    <mat-form-field appearance="outline" class="full">
      <mat-label>{{ 'layersEntity.order' | translate }}</mat-label>
      <input matInput type="number" formControlName="order">
    </mat-form-field>
    <mat-form-field appearance="outline" class="full">
      <mat-label>{{ 'layersEntity.type' | translate }}</mat-label>
      <mat-select formControlName="type">
        <mat-option [value]="type.value" *ngFor="let type of parameterTypes">
          {{ type.description }}
        </mat-option>
      </mat-select>
    </mat-form-field>
  </form>
</ng-template>


<ng-template #newSpatialConfigurationDialog>
  <form [formGroup]='parameterForm'>
    <mat-form-field appearance="outline" class="full">
      <mat-label>{{ 'layersEntity.field' | translate }}</mat-label>
      <input matInput type="text" formControlName="value" required>
    </mat-form-field>
    <mat-form-field appearance="outline" class="full">
      <mat-label>{{ 'layersEntity.alias' | translate }}</mat-label>
      <input matInput type="text" formControlName="name" required>
    </mat-form-field>
    <mat-form-field appearance="outline" class="full">
      <mat-label>{{ 'layersEntity.format' | translate }}</mat-label>
      <mat-select formControlName="format" required>
        <mat-option [value]="formatType.value" *ngFor="let formatType of spatialSelectionParameterFormatTypes">
          {{ formatType.description }}
        </mat-option>
      </mat-select>
    </mat-form-field>
    <mat-form-field appearance="outline" class="full">
      <mat-label>{{ 'layersEntity.type' | translate }}</mat-label>
      <mat-select formControlName="type" required>
        <mat-option [value]="type.value" *ngFor="let type of spatialSelectionParameterTypes">
          {{ type.description }}
        </mat-option>
      </mat-select>
    </mat-form-field>
  </form>
</ng-template>


<ng-template #newStyleDialog>
  <form [formGroup]='styleForm'>
    <mat-form-field appearance="outline" class="full">
      <mat-label>{{ 'layersEntity.name' | translate }}</mat-label>
      <input matInput type="text" formControlName="name" required>
    </mat-form-field>
    <mat-form-field appearance="outline" class="full">
      <mat-label>{{ 'layersEntity.title' | translate }}</mat-label>
      <input matInput type="text" formControlName="title">
    </mat-form-field>
    <mat-form-field appearance="outline" class="full">
      <mat-label>{{ 'layersEntity.description' | translate }}</mat-label>
      <input matInput type="text" formControlName="description">
    </mat-form-field>
    <mat-form-field appearance="outline" class="full">
      <mat-label>{{ 'layersEntity.format' | translate }}</mat-label>
      <input matInput type="text" formControlName="format">
    </mat-form-field>


    <!-- <div class="colFormDiv">
      <label class="formLabel ">
        {{'layersEntity.format' | translate}}
      </label>
      <mat-form-field appearance="outline">
        <mat-select matInput formControlName="format">
          <mat-option [value]="formatType.value" *ngFor="let formatType of parameterFormatTypes">
            {{ formatType.description}}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div> -->

    <mat-form-field appearance="outline" class="full">
      <mat-label>{{ 'layersEntity.width' | translate }}</mat-label>
      <input matInput type="number" formControlName="width">
    </mat-form-field>
    <mat-form-field appearance="outline" class="full">
      <mat-label>{{ 'layersEntity.height' | translate }}</mat-label>
      <input matInput type="number" formControlName="height">
    </mat-form-field>
    <mat-form-field appearance="outline" class="full">
      <mat-label>{{ 'layersEntity.url' | translate }}</mat-label>
      <input matInput type="text" formControlName="url">
    </mat-form-field>
    <mat-checkbox formControlName="defaultStyle" class="full">
      {{ 'layersEntity.defaultStyle' | translate }}
    </mat-checkbox>
  </form>
</ng-template>

<ng-template #newTerritorialFilterDialog>

  <form [formGroup]='territorialFilterForm'>
    <mat-form-field appearance="outline" class="full">
      <mat-label>{{ 'layersEntity.name' | translate }}</mat-label>
      <input matInput type="text" formControlName="name">
    </mat-form-field>
    <mat-form-field appearance="outline" class="full">
      <mat-label>{{ 'layersEntity.column' | translate }}</mat-label>
      <input matInput type="text" formControlName="column">
    </mat-form-field>
    <mat-form-field appearance="outline" class="full">
      <mat-label>{{ 'layersEntity.value' | translate }}</mat-label>
      <input matInput type="text" formControlName="values">
    </mat-form-field>
    <mat-form-field appearance="outline" class="full">
      <mat-label>{{ 'layersEntity.type' | translate }}</mat-label>
      <mat-select formControlName="type">
        <mat-option [value]="filterType.value" *ngFor="let filterType of filterTypes">
          {{ filterType.description }}
        </mat-option>
      </mat-select>
    </mat-form-field>
    <mat-form-field appearance="outline" class="full">
      <mat-label>{{ 'layersEntity.valueType' | translate }}</mat-label>
      <mat-select formControlName="valueType">
        <mat-option [value]="valueType.value" *ngFor="let valueType of filterValueTypes">
          {{ valueType.description }}
        </mat-option>
      </mat-select>
    </mat-form-field>
    <mat-form-field appearance="outline" class="full">
      <mat-label>{{ 'layersEntity.typeId' | translate }}</mat-label>
      <mat-select formControlName="territorialLevel">
        <mat-option [value]="typeId.id" *ngFor="let typeId of filterTypeIds">
          {{ typeId.name }}
        </mat-option>
      </mat-select>
    </mat-form-field>
    <mat-checkbox formControlName="required">
      {{ 'layersEntity.required' | translate }}
    </mat-checkbox>
  </form>
</ng-template>
